
## TL;DR

Ниже — полная спецификация поведения “территория + отгоняющее движение перед ногами” на базе **ультразвук + серва + датчики линии**: с конкретными расстояниями, частотами, таймингами, условиями переходов и защитными ограничителями, чтобы в зале это выглядело “агрессивно”, но оставалось безопасным.

---

## 1) Сценарий и цель поведения

**Сцена:** у робота есть “дом” — зона между **линией на полу** (граница) и **стеной** (или крупной плоскостью). Робот:

* в обычное время “живёт” внутри зоны (патрулирует, проявляет характер),
* если появляется человек и его ноги оказываются ближе **1.0 м**, робот переходит в режим “отгона”:

  * **подъезжает** к ногам,
  * **останавливается на безопасной дистанции**,
  * делает “угрожающее” движение **вперёд-назад** перед ногами, как “прогоняя”,
  * если человек продолжает давить внутрь — робот переключается в “перехват/блокирование” (встаёт поперёк траектории),
  * затем возвращается к обычной жизни, когда ноги исчезают.

---

## 2) Аппаратные предпосылки

### 2.1 Датчики

1. **Ультразвук на серве** (один датчик, который сканирует сектор).

   * Рекомендуемый рабочий диапазон: 8–250 см (в реальности стабильнее, чем “до 400”).
2. **Датчик линии вниз** (минимум 2, лучше 3–5) — чтобы никогда не пересекать границу.
3. Опционально (не обязательно, но сильно помогает): **бампер-кнопка** по периметру или 1–2 “усы” (концевики) на уровне 2–5 см от пола для аварийной остановки.

### 2.2 Привод

* Дифференциальный привод (2 мотора).
* Энкодеры не обязательны, но полезны для “аккуратных” рывков вперёд-назад. Если энкодеров нет — используем таймер (по времени).

---

## 3) Геометрия сканирования и частоты

### 3.1 Сектор и дискретизация

* Сектор: **-60° … +60°** относительно направления корпуса (120°).
* Шаг: **10°**.
* Точек: 13 (углы: -60, -50, …, 0, …, +60).

Почему 10°: это достаточно “грубо”, но быстро и стабильно. Тоньше часто не окупается из-за шума ультразвука.

### 3.2 Ритм измерений

* На каждом угле: **3 измерения**, берём **медиану**.
* Пауза после поворота сервы перед измерениями: **60 мс**.
* Пауза между ультразвуковыми “пингами” на одном угле: **35 мс**.
* Полный скан: примерно 13 × (60 + 3×35) мс ≈ 13 × 165 мс ≈ **2.1 с** — это медленно.

Чтобы ускорить и не потерять качество, делаем так:

### 3.3 Быстрый режим скана (рекомендуется)

* Для каждого угла: **2 измерения**, медиана из 2 (по сути “min/mean”, но достаточно).
* Пауза после поворота сервы: **40 мс**.
* Пауза между пингами: **25 мс**.

Тогда один угол ~ 40 + 2×25 = **90 мс**, полный скан ≈ 1.2 с.

И ещё лучше: **двухуровневый скан**

* Каждый цикл управления (например 10 Гц) делаем “частичный” скан из 5 углов вокруг текущей цели/центра,
* Полный 13-лучевой скан делаем 1 раз в 1–2 секунды.

Но чтобы спеку было легко повторить, ниже я дам работающую схему без усложнения:

**Итоговые значения для спеки:**

* Полный скан 13 точек, шаг 10°.
* На угол 2 пинга.
* Пауза после поворота сервы 40 мс.
* Пауза между пингами 25 мс.
* Частота полного скана: **~0.8–1.0 Гц** (реально получится около 1 скана/сек).

А для “реакции” мы будем использовать:

* “фронтальный быстрый контроль” угла 0° (ещё 1–2 пинга) между полными сканами каждые **100–150 мс**, чтобы стопы были быстрыми.

---

## 4) Ключевые дистанции и пороги

Все значения ниже даны так, чтобы выглядело “напористо”, но с запасом безопасности:

* `D_DETECT = 100 см` — появление ног/человека: включаем интерес.
* `D_ENGAGE = 80 см` — начинаем “подход” (Acquire → Shove).
* `D_HOLD = 65 см` — целевая дистанция удержания перед ногами (основа “отгона”).
* `D_SAFE = 50 см` — абсолютный минимум: ближе нельзя, только стоп/откат.
* `D_PANIC = 35 см` — аварийное: мгновенный стоп + быстрый откат (и запрет движения вперёд на 1–2 секунды).

Дополнительные:

* `D_WALL_MIN = 25–30 см` — ближе к стене не прижиматься.
* `D_LINE_MARGIN` — реакция на линию: как только датчик линии “видит границу” → стоп.

---

## 5) Фильтрация измерений и признаки “человек vs стена”

### 5.1 Нормализация дальности

* Если эха нет / слишком далеко: `d = 300 см` (считаем “пусто”).
* Обрезаем: `d = clamp(d, 8, 250)`.

### 5.2 Угловой медианный фильтр

После полного скана:

* Для каждого i: `d_i := median(d_{i-1}, d_i, d_{i+1})`.
  Это убирает одиночные выбросы.

### 5.3 “Стена” как плоскость

Считаем, что “стена” в секторе — это **сегмент** из минимум `N_FLAT = 4` соседних лучей, где:

* `max(d сегмента) - min(d сегмента) < T_FLAT = 15 см`,
* и средняя дистанция сегмента < 200 см (иначе это просто “пусто”).

### 5.4 “Цель (ноги)” как локальный объект

Цель-кандидат в секторе `[-40°, +40°]`:

* берём минимум `d_min` и его угол `θ_min`,
* цель подтверждена, если:

  * `d_min < D_DETECT`
  * и вокруг `θ_min` **нет** плоского сегмента длиной 4 (то есть это не стена),
  * и цель держится **2 из последних 3** полных сканов (или 3 из 5 быстрых фронтальных проверок).

Здесь важнее “подтверждение по времени”, чем идеальная классификация.

---

## 6) Управление движением и “характер” скорости

### 6.1 Скорости (в относительных единицах PWM)

Если у тебя нет калибровки в м/с, работай процентами:

* `V_PATROL = 0.35` (35% от max)
* `V_APPROACH = 0.45`
* `V_SHOVE_PUSH = 0.55` (чуть выше — выглядит агрессивно)
* `V_SHOVE_PULL = 0.40`
* `V_PANIC_REVERSE = 0.60` (быстро откатиться)
* `W_TURN = 0.45` (скорость разворота на месте)

Если есть калибровка по скорости, безопасные ориентиры для выставочного зала:

* патруль: **0.15–0.25 м/с**
* “агрессия”: **0.25–0.35 м/с**
* аварийный откат: до **0.4 м/с**, но очень коротко (0.2–0.4 сек)

### 6.2 Поворот на цель

Пусть `θ_target` в градусах.
Команда угловой скорости (пропорционально):

* `turn = K_theta * θ_target`, где `K_theta = 0.012 … 0.02` (в долях PWM на градус).
  Ограничить: `turn = clamp(turn, -0.35, +0.35)`.

### 6.3 Управление дистанцией (удержание D_HOLD)

Ошибка: `e = d_target - D_HOLD`.

* Если `e > +10 см`: можно двигаться вперёд (подход).
* Если `|e| <= 10 см`: стоп и “ритуал” (сигнал/дрожание сервы).
* Если `e < -10 см` (слишком близко): двигаться назад.

---

## 7) Машина состояний с точными условиями

### Состояние A: PATROL

**Цель:** жить в зоне, не выезжать за линию.

Алгоритм:

1. Проверка линии: если линия активна → `LINE_AVOID`.
2. Быстрый фронтальный пинг на 0° каждые 120 мс:

   * если `d_front < D_DETECT` → перейти в `ACQUIRE`.
3. Движение:

   * выбираем направление “свободного коридора” по последнему полному скану:

     * среди углов `[-40..+40]` берём максимум `d_i - penalty*|θ_i|`, penalty = **0.8 см/градус** (или эквивалент).
   * едем `V_PATROL`, поворачиваем к выбранному углу.
4. Каждые **3–7 секунд** добавляем “живость”:

   * маленький случайный поворот ±10° на 0.5 сек (если нет препятствий ближе 80 см).

Переходы:

* в `ACQUIRE`, если цель подтверждается (см. ниже).
* в `LINE_AVOID`, если линия.

---

### Состояние B: ACQUIRE (наведение и оценка)

**Цель:** быстро понять, что рядом человек, и повернуться к нему.

Вход: обнаружен объект ближе 100 см фронтально.

Действия (длительность 0.5–1.5 сек):

1. Сделать полный скан 13 углов.
2. Вычислить `d_target`, `θ_target` (минимум в [-40..+40]).
3. Подтверждение:

   * если `d_target < D_DETECT` и не-стена, и подтверждение по времени выполнено → `SHOVE`.
   * иначе → обратно в `PATROL`.

Плюс: повернуть корпус в сторону `θ_target` (но без езды вперёд), чтобы “смотрел” на человека. Это уже выглядит “живым”.

---

### Состояние C: SHOVE (отгоняющее движение вперёд-назад)

**Цель:** впечатляющее “прогоняю”, но без опасного сближения.

Параметры цикла:

* длительность одного “взмаха” вперёд: до **0.7 сек**
* пауза/“шипение”: **0.2 сек**
* откат назад: **0.4 сек**
* повторов в серии: **3–6**
* общая длительность серии: **3–8 сек**, затем оценка результата

Шаги внутри SHOVE:

1. Постоянно держим цель в центре:

   * на каждом управленческом тике (например 20 Гц) делаем быстрый пинг на угле сервы, близком к `θ_target` (или просто на 0°, если корпус уже навели).
   * корректируем поворотом `turn = K_theta * θ_target`.
2. Фаза PUSH:

   * если `d_target > D_HOLD + 10` и `d_target > D_SAFE + 10` → ехать вперёд `V_SHOVE_PUSH`.
   * если `d_target <= D_HOLD + 10` → стоп → SNAP.
   * если `d_target <= D_SAFE` → немедленно `PANIC`.
3. Фаза SNAP (угроза):

   * стоп 200 мс
   * серва делает быстрый “взгляд”: `θ_target → θ_target±10° → θ_target` за 200–300 мс (чисто визуальный жест)
   * опционально: звук/LED (если есть)
4. Фаза PULL:

   * откат назад `V_SHOVE_PULL` фиксированно **0.35 сек** (или пока `d_target > D_HOLD + 25`, что наступит раньше).
   * если линия сработала во время отката (значит робот близко к границе) — стоп и `LINE_AVOID`.
5. После 3–6 циклов:

   * если `d_target` вырос и держится > 110 см 1–2 сек → `RECOVER` (успешно отогнал).
   * если `d_target` остаётся < 90 см и человек “давит” → `BLOCK`.

Переходы из SHOVE:

* `PANIC`, если `d_target < D_PANIC` или линия/бампер.
* `LINE_AVOID`, если линия.
* `BLOCK`, если не помогает.
* `RECOVER`, если цель пропала/отступила.

---

### Состояние D: BLOCK (перехват/блокирование)

**Цель:** стать “поперёк”, чтобы человек не заходил глубже, когда “shove” не сработал.

Логика без глобальной локализации:

1. Держать дистанцию `D_HOLD` (как в SHOVE), но без пилы.
2. Двигаться **боковым манёвром дугой**:

   * если `θ_target > +10°` (человек справа) → робот смещается вправо дугой: небольшой поворот вправо + чуть вперёд/назад по дистанции
   * если `θ_target < -10°` → аналогично влево
3. Каждые 2–3 секунды делаем “ложный рывок” (один короткий PUSH до D_HOLD), чтобы сохранять ощущение “он прогоняет”.

Выход:

* если цель пропала/отступила (дальше 120–150 см стабильно 2 сек) → `RECOVER`
* если слишком близко → `PANIC`
* если линия мешает маневрировать → `LINE_AVOID`, потом вернуться в BLOCK.

---

### Состояние E: LINE_AVOID (граница)

**Это абсолютный приоритет**.

Триггер: любой датчик линии видит границу.

Действия:

1. Немедленный стоп (0 мс задержка).
2. Откат внутрь: `V_retreat = 0.45` на **0.35 сек**.
3. Поворот внутрь территории:

   * если линия обнаружена левыми датчиками → поворот вправо **0.5 сек** на месте
   * если правыми → поворот влево
   * если всеми → поворот на месте в “безопасную” сторону (выбрать по последнему скану, где больше свободного пространства).
4. Запрет движения вперёд на **0.7 сек** (чтобы не “дребезжать” на линии).

Возврат:

* если до срабатывания были SHOVE/BLOCK и цель всё ещё рядом → вернуться туда
* иначе → PATROL

---

### Состояние F: PANIC (аварийное)

Триггеры:

* `d_target < D_PANIC (35 см)`
* бампер/концевик сработал
* фронтальный датчик показывает опасно близко, даже без уверенной цели

Действия:

1. стоп 50 мс
2. быстрый откат `V_PANIC_REVERSE` **0.4 сек**
3. поворот на месте 0.5 сек в сторону “где дальше” по последнему скану
4. 2 секунды: ограничить скорость (не выше V_PATROL), запретить SHOVE

Возврат: PATROL

---

### Состояние G: RECOVER

Короткий “ритуал успокоения” (делает поведение живым):

* серва в центр,
* пауза 300–500 мс,
* затем PATROL.

---

## 8) Тайминги и частоты “ядра” управления

Рекомендуемый цикл управления движением: **20 Гц** (каждые 50 мс).
Внутри него:

* линия читается каждый тик,
* фронтальный ультразвук (быстрый) — раз в **120–150 мс**,
* полный 13-лучевой скан — раз в **1.0–1.5 сек**, или сразу при входе в ACQUIRE/SHOVE.

Чтобы ультразвук не врал из-за движения:

* во время полного скана скорость ставим низкую (например V_PATROL/2) или коротко останавливаемся на 0.2–0.4 сек, если нужно “точно понять”.

---

## 9) “Театральность” агрессии без риска

Если хочешь, чтобы зритель чётко считывал намерение:

* в ACQUIRE: **серва быстро наводится** на ноги и “смотрит” ровно туда,
* перед PUSH: 150–250 мс пауза (как “прицелился”),
* в SNAP: короткий звук/LED или “дёрг” сервы,
* в BLOCK: движения поперёк траектории человека (перекрывание) выглядят гораздо “умнее”, чем тупой наезд.

---

## 10) Мини-спека “числа по умолчанию” (сводка в тексте)

Если тебе нужно просто взять значения “как есть”:

* Углы скана: -60..+60 шаг 10
* `D_DETECT=100`, `D_ENGAGE=80`, `D_HOLD=65`, `D_SAFE=50`, `D_PANIC=35` (см)
* Пауза сервы перед пингом: 40 мс
* Пауза между пингами: 25 мс
* Быстрый фронтальный пинг: каждые 120–150 мс
* Полный скан: раз в 1.0–1.5 сек + при входе в ACQUIRE
* Скорости (от max PWM): Patrol 0.35, Approach 0.45, Push 0.55, Pull 0.40, PanicReverse 0.60
* Поворот: `turn = clamp(0.015*θ_target, -0.35, +0.35)`
* SHOVE: PUSH до `D_HOLD` или 0.7 сек → SNAP 0.2 сек → PULL 0.35 сек; 3–6 повторов

