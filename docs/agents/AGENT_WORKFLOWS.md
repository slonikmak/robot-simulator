# AI Agent Constitution & Workflow

Этот документ описывает строгий процесс работы автономных агентов и команды в данном репозитории. Цель процесса — максимальная автономность агентов при минимальном, но жестком контроле со стороны человека (Plan Gate).

## 1. Базовые принципы (The Golden Rules)

* **Один PR на задачу:** Анализ (план), обновление требований и код живут в рамках одного Pull Request.
* **Спецификация — единственный источник истины:** Любое изменение поведения должно быть описано в `spec.md` под уникальным номером `R-XXX`.
* **«Зачем» всегда рядом с кодом:** Каждый PR и каждый коммит, меняющий поведение, должен содержать мотивацию (`Why: ...`).
* **Жесткий WIP-лимит:** Агент берет в работу не более 1–2 задач одновременно для предсказуемости.
* **Никакого кода без утвержденного плана:** Запрещено менять директории `src/` и `tests/` до получения лейбла `plan:approved`.

## 2. Состояния и лейблы (FSM)

Жизненный цикл задачи управляется лейблами на Issue и PR.

* `status:backlog`: Входящая задача или PR, ожидающий утверждения плана (Plan Gate).
* `plan:approved` (на PR): План проверен командой, разрешено писать код.
* `plan:changes-requested` (на PR): План требует доработки, писать код запрещено.
* `status:todo`: План утвержден, задача готова к реализации.
* `status:in-progress`: Агент активно пишет код по утвержденному плану.
* `status:done`: Задача завершена, PR смержен.

## 3. Контракты артефактов

### 3.1. Нормализация заголовков Issue
На этапе подготовки агент обязан переименовать Issue в рабочий формат: `feat/fix/spec/chore(area): ...`. Использование `idea(...)` допускается только на этапе Intake.

### 3.2. Файл плана (tasks/T-XXXX.md)
План создается первым коммитом в PR и должен содержать:
* Короткий список шагов реализации (3–7 проверяемых чекбоксов).
* Ожидаемый результат (Goal) и критерии приемки (Acceptance).

### 3.3. Шаблон PR Body
Каждый PR должен содержать:
* `Fixes #XXXX`
* `Spec: R-XXX` (или `New requirement`)
* `Plan: tasks/T-XXXX.md`
* `Why: <2-5 строк мотивации>`

## 4. Макро-команды агента (Skills)

Агент оперирует четырьмя основными командами:

1.  **`capture`**: Создать сырое Issue в `status:backlog`.
2.  **`prepare`**: Взять Issue из backlog, нормализовать заголовок, создать ветку, написать `tasks/T-XXXX.md`, обновить `spec.md` (если нужно) и открыть PR для прохождения Plan Gate.
3.  **`execute`**: Дождаться `plan:approved`, перевести Issue в `status:in-progress`, написать код и тесты, обновить описание PR. Обязательно оставить комментарий в Issue о начале работы над кодом.
4.  **`report`**: Вывести текущее состояние очередей (backlog, todo, in-progress, open PRs).

## 5. Основные сценарии (Workflows)

### Сценарий 1: Новая фича с существующим требованием (R-XXX существует)

* **Issue:** Агент создает или нормализует задачу в формате `feat(area): implement R-0XX ...`.
* **Plan PR:** Создается ветка и первый коммит, содержащий план в `tasks/T-XXXX.md`. Изменения в коде (`src/`, `tests/`) на этом этапе запрещены.
* **Plan Gate:** Команда ревьюит план и ставит лейбл `plan:approved`. Задача переходит в `status:todo`.
* **Implement:** Агент пишет код и тесты, добавляя коммиты (например, `feat(...)` и `test(...)`) в тот же PR.

### Сценарий 2: Новая фича БЕЗ требований (Spec-first)

* **Issue:** Нормализуется как `feat(area): ...` с обязательным указанием `Spec: New requirement` в теле.
* **Plan PR:** Первый коммит включает план `tasks/T-XXXX.md` и добавление нового требования `R-0YY` в `spec.md`.
* **Plan Gate:** Команда утверждает как сам план, так и предлагаемую формулировку требования в `spec.md`.
* **Implement:** После апрува агент реализует функционал и тесты, покрывающие новое `R-0YY`.

### Сценарий 3: Баг с нарушением существующего требования

* **Issue:** Заголовок `fix(area): ...` с указанием нарушенного контракта `Spec: R-XXX`.
* **Plan PR:** Агент коммитит в PR только план расследования и фикса в `tasks/T-XXXX.md`.
* **Plan Gate:** Команда одобряет подход к исправлению.
* **Implement:** Агент пишет **падающий регрессионный тест**, затем код фикса, затем проверяет прохождение теста.

### Сценарий 4: Баг БЕЗ спецификации (Узаконивание ожидания)

* **Issue:** Создается как `fix(area): <симптом>` в `status:backlog`. Поскольку контракта нет, это еще не «баг», а «неоправданное ожидание».
* **Plan PR:** Агент готовит PR без кода, который включает план `tasks/T-XXXX.md` и добавляет новое/уточненное требование `R-0YY` в `spec.md`, фиксируя правильное поведение.
* **Plan Gate:** Команда ревьюит `spec.md` (согласна ли она с такой трактовкой нормы) и ставит `plan:approved`.
* **Implement:** Пишется регрессионный тест, затем фикс.

### Сценарий 5: Уточнение требования без кода (Spec-only)

* **Issue:** Заголовок `spec(area): ...`. Используется, когда нужно только зафиксировать правила.
* **Plan PR:** Включает `tasks/T-XXXX.md` и изменения в `spec.md`.
* **Plan Gate & Merge:** После получения `plan:approved` фаза реализации кода пропускается. PR сразу мержится командой.

### Сценарий 6: Техдолг или Рефакторинг (Без изменения поведения)

* **Issue:** Оформляется как `chore(area): ...`. Изменения в `spec.md` обычно не требуются, но секция `Why:` в PR обязательна.
* **Plan PR:** Создается `tasks/T-XXXX.md` с планом изменений и описанием того, как будет проверено отсутствие регрессий.
* **Implement:** Агент вносит изменения и доказывает их безопасность (через существующие тесты).

### Сценарий 7: Доработка архитектуры (Audit-first)

* **Фаза 1 (Аудит):** Создается задача `chore(area): architecture audit ...`. PR этой фазы содержит только `tasks/T-XXXX.md`, результаты анализа и архитектурные решения в `adr/000X-...md`. **Изменение кода в этой фазе запрещено.** PR мержится для фиксации решения.
* **Фаза 2 (Реализация):** По итогам аудита создаются новые задачи (`feat/fix/chore`). Каждая проходит стандартный цикл с Plan Gate в новом PR.

### Сценарий 8: Изменение Scope в процессе (Re-plan)

* **Ситуация:** Во время реализации (`status:in-progress`) агент понимает, что план или требования (`spec.md`) нужно существенно изменить.
* **Действие:** Агент обновляет `tasks/T-XXXX.md` и `spec.md` в текущем PR.
* **Re-Gate:** Снимается лейбл `plan:approved`, ставится `plan:changes-requested` (или `plan:re-approve`). Статус issue может вернуться в `status:backlog`.
* **Continue:** Только после повторного получения `plan:approved` агент продолжает работу над кодом.